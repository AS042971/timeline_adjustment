<div>
  <div class="artplayer-app" style="width: auto; height: 60vh; position: relative;"></div>
  <table class="timeline" cellspacing="10px"></table>
</div>
<script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer-plugin-danmuku/dist/artplayer-plugin-danmuku.js"></script>
<script>
  var art = new Artplayer({
    container: document.querySelector('.artplayer-app'),
    url: 'https://jsxm.sharepoint.cn/sites/nf-asoul/_layouts/15/download.aspx?UniqueId=f83e9fde-5601-481b-80eb-5b52d8f54a54&Translate=false&tempauth=eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIwMDAwMDAwMy0wMDAwLTBmZjEtY2UwMC0wMDAwMDAwMDAwMDAvanN4bS5zaGFyZXBvaW50LmNuQGE4Y2NjNDgzLTY1NjktNDlhMC1hNjYxLWQ2YTFmMTViOWZhMSIsImlzcyI6IjAwMDAwMDAzLTAwMDAtMGZmMS1jZTAwLTAwMDAwMDAwMDAwMCIsIm5iZiI6IjE2NDg2MjI5NzEiLCJleHAiOiIxNjQ4NjI2NTcxIiwiZW5kcG9pbnR1cmwiOiJoeFBwSFllUTZwaTFWa21YTXBBV0dERmoxWDd4bTBiaUExM3o2QkVBUjlRPSIsImVuZHBvaW50dXJsTGVuZ3RoIjoiMTI5IiwiaXNsb29wYmFjayI6IlRydWUiLCJjaWQiOiJOREZoTnpSalltVXROR1kwTUMwME5tUXlMV0UyTnprdE5tVXpZMkkyT1RBd05UZ3oiLCJ2ZXIiOiJoYXNoZWRwcm9vZnRva2VuIiwic2l0ZWlkIjoiWVRCa00yTm1OVEl0WWpWaFppMDBPV013TFRneE4yVXRaakU0T0RJME16QTVZMll5IiwiYXBwX2Rpc3BsYXluYW1lIjoiQVNPVUwtQ04xIiwiYXBwaWQiOiI4MDUzOTM4Mi1lOWYzLTRhOGItYmMwYi02ZDg3ZTMzYTQyYTIiLCJ0aWQiOiJhOGNjYzQ4My02NTY5LTQ5YTAtYTY2MS1kNmExZjE1YjlmYTEiLCJ1cG4iOiJrbmFpZmVuQGFzZi5pbmsiLCJwdWlkIjoiMTAwMzMyMzBDNjQ2QUQ4NCIsImNhY2hla2V5IjoiMGguZnxtZW1iZXJzaGlwfDEwMDMzMjMwYzY0NmFkODRAbGl2ZS5jb20iLCJzY3AiOiJhbGxzaXRlcy5yZWFkIGFsbHNpdGVzLndyaXRlIiwidHQiOiIyIiwidXNlUGVyc2lzdGVudENvb2tpZSI6bnVsbCwiaXBhZGRyIjoiNDAuNzIuNzQuMTkyIn0.eGJ5UzZXNkFMMHhzYndNcTFEaE81WERaQXdVcUxrQVIxTUhMbSt3UGp3cz0&ApiVersion=2.0',
    plugins: [
      artplayerPluginDanmuku({
        danmuku: 'https://dm.asdanmaku.com/Xml/2021.12.11 【A-SOUL】周年特别直播.xml',
        speed: 11, // 全局持续时间
        opacity: 0.7, // 全局透明度
        size: 30, // 全局字体大小
        maxlength: 100, // 全局最大长度
        synchronousPlayback: true, // 是否同步到播放速度
        margin: [0, 0]
      }),
    ],
    settings: [{
        width: 150,
        html: '弹幕开关',
        selector: [
          {
            default: true,
            html: '显示',
            showDanmuku: true
          },
          {
            html: '隐藏',
            showDanmuku: false
          },
        ],
        onSelect: function (item) {
          if (item.showDanmuku) {
            art.plugins.artplayerPluginDanmuku.show();
          } else {
            art.plugins.artplayerPluginDanmuku.hide();
          }
        },
      },
      {
        width: 150,
        html: '弹幕大小',
        selector:[
          {
            html: '很小 (12px)',
            size: 12
          },
          {
            html: '较小 (20px)',
            size: 20
          },
          {
            default: true,
            html: '适中 (30px)',
            size: 30
          },
          {
            html: '较大 (40px)',
            size: 40
          },
          {
            html: '很大 (50px)',
            size: 50
          }
        ],
        onSelect: function (item) {
          art.plugins.artplayerPluginDanmuku.config({
            fontSize: item.size,
          }).option.margin[1] = art.height / 2;
        },
      },
      {
        width: 150,
        html: '弹幕不透明度',
        selector:[
          {
            html: '30%',
            opacity: 0.3
          },
          {
            html: '50%',
            opacity: 0.5
          },
          {
            default: true,
            html: '70%',
            opacity: 0.7
          },
          {
            html: '90%',
            opacity: 0.9
          },
          {
            html: '100%',
            opacity: 1.0
          }
        ],
        onSelect: function (item) {
          art.plugins.artplayerPluginDanmuku.config({
            opacity: item.opacity,
          }).option.margin[1] = art.height / 2;
        },
      }
    ],
    setting: true,
    whitelist: ['*'],
    autoSize: true,
    autoMini: true,
    flip: true,
    volume: 0.5,
    rotate: true,
    playbackRate: true,
    hotkey: true,
    pip: true,
    fullscreen: true,
    fullscreenWeb: true,
  });

  pluginOption = art.plugins.artplayerPluginDanmuku.config().option;
  console.log(pluginOption)
  art.on('resize', () => {
    pluginOption.margin[1] = art.height / 2;
  });

  fetch('https://asoul.knaifen.workers.dev/ASOUL-REC-%E4%BA%8C%E5%91%A8%E5%B9%B4/PBF%E4%B9%A6%E7%AD%BE%E6%96%87%E4%BB%B6/2021.12.11%20%E3%80%90A-SOUL%E3%80%91%E5%91%A8%E5%B9%B4%E7%89%B9%E5%88%AB%E7%9B%B4%E6%92%AD.pbf')
    .then(response => response.text())
    .then(rawPBFStr => {

      var timelineTable = document.querySelector('.timeline')
      var highlight = []

      var rawPBFList = rawPBFStr.split(/[(\r\n)\r\n]+/);
      rawPBFList.shift()
      rawPBFList.forEach(PBFItem => {
        if (!PBFItem) {
          return
        }
        var PBFParts = PBFItem.split('*')
        if (PBFParts.length <= 2) {
          return
        }
        var timeMarker = PBFParts.shift()
        var timeMarkerParts = timeMarker.split('=')
        var time = parseInt(timeMarkerParts[1]) / 1000
        var text = PBFParts[0]

        timeButtonTd = document.createElement('td');
        timeButtonTd.innerText = new Date(time * 1000).toISOString().substr(11, 8);
        timeTextTd = document.createElement('td');
        timeTextTd.innerText = text;

        timelineRow = document.createElement('tr');
        timelineRow.style.cursor = "pointer";
        timelineRow.addEventListener('click', () => {
          art.seek = time;
        })
        timelineRow.appendChild(timeButtonTd);
        timelineRow.appendChild(timeTextTd);
        timelineTable.appendChild(timelineRow);

        highlight.push({
          "time": time,
          "text": text
        });
      });

      console.log(highlight)
      art.option.highlight = highlight;
    })
</script>
